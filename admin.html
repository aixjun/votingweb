<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>íˆ¬í‘œ ì‹œìŠ¤í…œ - ê´€ë¦¬ì</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="css/style.css">
</head>
<body>
  <div class="container">
    <header class="header">
      <h1>âš™ï¸ ê´€ë¦¬ì í˜ì´ì§€</h1>
      <p id="adminName">ê´€ë¦¬ìë‹˜ í™˜ì˜í•©ë‹ˆë‹¤</p>
    </header>

    <main>
      <!-- ì—‘ì…€ ì—…ë¡œë“œ ì„¹ì…˜ -->
      <div class="card admin-section">
        <h2>ğŸ“ ë°ì´í„° ì—…ë¡œë“œ</h2>

        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 20px;">
          <!-- ì°¸ì—¬ì ì—…ë¡œë“œ -->
          <div>
            <h3 style="margin-bottom: 10px; font-size: 1rem;">ì°¸ì—¬ì(ì²­ì¤‘) ì—‘ì…€</h3>
            <div class="file-upload" onclick="document.getElementById('participantFile').click()">
              <input type="file" id="participantFile" accept=".xlsx,.xls" onchange="handleParticipantUpload(event)">
              <p>ğŸ“¤ í´ë¦­í•˜ì—¬ ì—…ë¡œë“œ</p>
              <p style="font-size: 0.8rem; margin-top: 5px;">ì‚¬ë²ˆ, ì´ë¦„, ë¶€ì„œ, ë¹„ë°€ë²ˆí˜¸</p>
            </div>
          </div>

          <!-- ë°œí‘œì ì—…ë¡œë“œ -->
          <div>
            <h3 style="margin-bottom: 10px; font-size: 1rem;">ë°œí‘œì(íŒ€) ì—‘ì…€</h3>
            <div class="file-upload" onclick="document.getElementById('presenterFile').click()">
              <input type="file" id="presenterFile" accept=".xlsx,.xls" onchange="handlePresenterUpload(event)">
              <p>ğŸ“¤ í´ë¦­í•˜ì—¬ ì—…ë¡œë“œ</p>
              <p style="font-size: 0.8rem; margin-top: 5px;">íŒ€ëª…, ë°œí‘œì, ì£¼ì œ, ìˆœì„œ</p>
            </div>
          </div>
        </div>
      </div>

      <!-- ì°¸ì—¬ì í˜„í™© -->
      <div class="card admin-section">
        <div class="toggle-section" onclick="toggleSection('participantSection')">
          <h2>ğŸ‘¥ ì°¸ì—¬ì í˜„í™© (<span id="participantCount">0</span>ëª…)</h2>
          <span class="arrow">â–¼</span>
        </div>
        <div class="toggle-content" id="participantSection">
          <table class="data-table" id="participantTable">
            <thead>
              <tr>
                <th>ì‚¬ë²ˆ</th>
                <th>ì´ë¦„</th>
                <th>ë¶€ì„œ</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>

      <!-- ë°œí‘œì í˜„í™© -->
      <div class="card admin-section">
        <div class="toggle-section" onclick="toggleSection('presenterSection')">
          <h2>ğŸ¤ ë°œí‘œì í˜„í™© (<span id="presenterCount">0</span>íŒ€)</h2>
          <span class="arrow">â–¼</span>
        </div>
        <div class="toggle-content" id="presenterSection">
          <table class="data-table" id="presenterTable">
            <thead>
              <tr>
                <th>ìˆœì„œ</th>
                <th>íŒ€ëª…</th>
                <th>ë°œí‘œì</th>
                <th>ì£¼ì œ</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>

      <!-- íˆ¬í‘œ ì§‘ê³„ -->
      <div class="card admin-section">
        <div class="toggle-section" onclick="toggleSection('voteSection')">
          <h2>ğŸ“Š íˆ¬í‘œ ì§‘ê³„ í˜„í™© (<span id="voteParticipantCount">0</span>ëª… ì°¸ì—¬)</h2>
          <span class="arrow">â–¼</span>
        </div>
        <div class="toggle-content" id="voteSection">
          <div id="voteResults"></div>
        </div>
      </div>

      <!-- ì„¤ì • -->
      <div class="card admin-section">
        <h2>âš™ï¸ ì„¤ì •</h2>
        <div style="margin-top: 15px;">
          <div class="form-group">
            <label for="maxVotesInput">ìµœëŒ€ íˆ¬í‘œ ìˆ˜</label>
            <input type="number" id="maxVotesInput" min="1" max="20" value="5">
          </div>
          <div style="margin-bottom: 15px;">
            <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
              <input type="checkbox" id="votingOpenCheck" checked style="width: 20px; height: 20px;">
              íˆ¬í‘œ í™œì„±í™”
            </label>
          </div>
          <button class="btn btn-primary" onclick="saveSettings()">ì„¤ì • ì €ì¥</button>
        </div>
      </div>

      <!-- ê´€ë¦¬ ë²„íŠ¼ -->
      <div class="card">
        <h2 style="margin-bottom: 15px;">ğŸ”§ ë°ì´í„° ê´€ë¦¬</h2>
        <div class="btn-group">
          <button class="btn btn-secondary" onclick="refreshData()">ìƒˆë¡œê³ ì¹¨</button>
          <button class="btn btn-danger" onclick="resetVotes()">íˆ¬í‘œ ë¦¬ì…‹</button>
          <button class="btn btn-danger" onclick="resetAllData()">ì „ì²´ ì´ˆê¸°í™”</button>
        </div>
      </div>

      <div style="margin-top: 20px;">
        <button class="btn btn-secondary" onclick="logout()">ë¡œê·¸ì•„ì›ƒ</button>
      </div>
    </main>

    <footer class="footer">
      <p>v1.0 | íˆ¬í‘œ ì‹œìŠ¤í…œ ê´€ë¦¬ì</p>
    </footer>
  </div>

  <!-- SheetJS for Excel -->
  <script src="https://cdn.sheetjs.com/xlsx-0.20.0/package/dist/xlsx.full.min.js"></script>
  <!-- Supabase -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="js/supabase-config.js"></script>
  <script src="js/api.js"></script>
  <script>
    let currentUser = null;

    document.addEventListener('DOMContentLoaded', async () => {
      // ê´€ë¦¬ì ì²´í¬
      currentUser = getCurrentUser();
      if (!currentUser || !currentUser.isAdmin) {
        window.location.href = 'index.html';
        return;
      }

      document.getElementById('adminName').textContent =
        `${currentUser.employee_id} ê´€ë¦¬ìë‹˜`;

      await loadAllData();
    });

    async function loadAllData() {
      await Promise.all([
        loadParticipants(),
        loadPresenters(),
        loadVoteResults(),
        loadSettings()
      ]);
    }

    async function loadParticipants() {
      try {
        const participants = await getParticipants();
        document.getElementById('participantCount').textContent = participants.length;

        const tbody = document.querySelector('#participantTable tbody');
        tbody.innerHTML = participants.map(p => `
          <tr>
            <td>${p.employee_id}</td>
            <td>${p.name}</td>
            <td>${p.department || '-'}</td>
          </tr>
        `).join('');
      } catch (error) {
        console.error('ì°¸ì—¬ì ë¡œë“œ ì‹¤íŒ¨:', error);
      }
    }

    async function loadPresenters() {
      try {
        const presenters = await getPresenters();
        document.getElementById('presenterCount').textContent = presenters.length;

        const tbody = document.querySelector('#presenterTable tbody');
        tbody.innerHTML = presenters.map(p => `
          <tr>
            <td>${p.display_order || '-'}</td>
            <td>${p.team_name}</td>
            <td>${p.presenter_name}</td>
            <td>${p.topic || '-'}</td>
          </tr>
        `).join('');
      } catch (error) {
        console.error('ë°œí‘œì ë¡œë“œ ì‹¤íŒ¨:', error);
      }
    }

    async function loadVoteResults() {
      try {
        const [results, participantCount] = await Promise.all([
          getVoteResults(),
          getVoteParticipantCount()
        ]);

        document.getElementById('voteParticipantCount').textContent = participantCount;

        const container = document.getElementById('voteResults');

        if (results.length === 0) {
          container.innerHTML = '<p style="color: #aaa; text-align: center; padding: 20px;">ì•„ì§ íˆ¬í‘œ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</p>';
          return;
        }

        const maxCount = Math.max(...results.map(r => r.count));

        container.innerHTML = results.map((r, i) => `
          <div style="margin: 15px 0;">
            <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
              <span><strong>${i + 1}ìœ„</strong> ${r.team_name} (${r.presenter_name})</span>
              <span>${r.count}í‘œ</span>
            </div>
            <div class="result-bar">
              <div class="result-bar-fill" style="width: ${(r.count / maxCount) * 100}%">
                ${Math.round((r.count / maxCount) * 100)}%
              </div>
            </div>
          </div>
        `).join('');
      } catch (error) {
        console.error('íˆ¬í‘œ ê²°ê³¼ ë¡œë“œ ì‹¤íŒ¨:', error);
      }
    }

    async function loadSettings() {
      try {
        const settings = await getSettings();
        document.getElementById('maxVotesInput').value = settings.max_votes || 5;
        document.getElementById('votingOpenCheck').checked = settings.voting_open !== false;
      } catch (error) {
        console.error('ì„¤ì • ë¡œë“œ ì‹¤íŒ¨:', error);
      }
    }

    // ì—‘ì…€ íŒŒì¼ ì²˜ë¦¬ - ì°¸ì—¬ì
    async function handleParticipantUpload(event) {
      const file = event.target.files[0];
      if (!file) return;

      try {
        const data = await readExcelFile(file);
        const participants = data.map(row => ({
          employee_id: String(row['ì‚¬ë²ˆ'] || row['employee_id'] || ''),
          name: row['ì´ë¦„'] || row['name'] || '',
          department: row['ë¶€ì„œ'] || row['department'] || '',
          password: String(row['ë¹„ë°€ë²ˆí˜¸'] || row['password'] || '')
        })).filter(p => p.employee_id && p.name);

        if (participants.length === 0) {
          alert('ìœ íš¨í•œ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤. ì—‘ì…€ í˜•ì‹ì„ í™•ì¸í•˜ì„¸ìš”.\ní•„ìˆ˜: ì‚¬ë²ˆ, ì´ë¦„, ë¹„ë°€ë²ˆí˜¸');
          return;
        }

        await upsertParticipants(participants);
        alert(`${participants.length}ëª…ì˜ ì°¸ì—¬ìê°€ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤.`);
        await loadParticipants();
      } catch (error) {
        alert('ì—…ë¡œë“œ ì‹¤íŒ¨: ' + error.message);
      }

      event.target.value = '';
    }

    // ì—‘ì…€ íŒŒì¼ ì²˜ë¦¬ - ë°œí‘œì
    async function handlePresenterUpload(event) {
      const file = event.target.files[0];
      if (!file) return;

      try {
        const data = await readExcelFile(file);
        const presenters = data.map((row, index) => ({
          team_name: row['íŒ€ëª…'] || row['team_name'] || '',
          presenter_name: row['ë°œí‘œì'] || row['presenter_name'] || '',
          topic: row['ì£¼ì œ'] || row['topic'] || '',
          display_order: row['ìˆœì„œ'] || row['order'] || index + 1
        })).filter(p => p.team_name && p.presenter_name);

        if (presenters.length === 0) {
          alert('ìœ íš¨í•œ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤. ì—‘ì…€ í˜•ì‹ì„ í™•ì¸í•˜ì„¸ìš”.\ní•„ìˆ˜: íŒ€ëª…, ë°œí‘œì');
          return;
        }

        await upsertPresenters(presenters);
        alert(`${presenters.length}ê°œ íŒ€ì´ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤.`);
        await loadPresenters();
      } catch (error) {
        alert('ì—…ë¡œë“œ ì‹¤íŒ¨: ' + error.message);
      }

      event.target.value = '';
    }

    // ì—‘ì…€ íŒŒì¼ ì½ê¸°
    function readExcelFile(file) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = (e) => {
          try {
            const workbook = XLSX.read(e.target.result, { type: 'binary' });
            const sheetName = workbook.SheetNames[0];
            const sheet = workbook.Sheets[sheetName];
            const data = XLSX.utils.sheet_to_json(sheet);
            resolve(data);
          } catch (error) {
            reject(error);
          }
        };
        reader.onerror = reject;
        reader.readAsBinaryString(file);
      });
    }

    // í† ê¸€ ì„¹ì…˜
    function toggleSection(sectionId) {
      const section = document.getElementById(sectionId);
      const parent = section.previousElementSibling;
      section.classList.toggle('open');
      parent.classList.toggle('open');
    }

    // ì„¤ì • ì €ì¥
    async function saveSettings() {
      const maxVotes = parseInt(document.getElementById('maxVotesInput').value) || 5;
      const votingOpen = document.getElementById('votingOpenCheck').checked;

      try {
        await updateSettings({ max_votes: maxVotes, voting_open: votingOpen });
        alert('ì„¤ì •ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.');
      } catch (error) {
        alert('ì„¤ì • ì €ì¥ ì‹¤íŒ¨: ' + error.message);
      }
    }

    // ë°ì´í„° ìƒˆë¡œê³ ì¹¨
    async function refreshData() {
      await loadAllData();
      alert('ë°ì´í„°ê°€ ìƒˆë¡œê³ ì¹¨ ë˜ì—ˆìŠµë‹ˆë‹¤.');
    }

    // íˆ¬í‘œ ë¦¬ì…‹
    async function resetVotes() {
      if (!confirm('ëª¨ë“  íˆ¬í‘œ ë°ì´í„°ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;

      try {
        await deleteAllVotes();
        alert('íˆ¬í‘œ ë°ì´í„°ê°€ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤.');
        await loadVoteResults();
      } catch (error) {
        alert('ì´ˆê¸°í™” ì‹¤íŒ¨: ' + error.message);
      }
    }

    // ì „ì²´ ì´ˆê¸°í™”
    async function resetAllData() {
      if (!confirm('ì •ë§ ëª¨ë“  ë°ì´í„°ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n(ì°¸ì—¬ì, ë°œí‘œì, íˆ¬í‘œ ëª¨ë‘ ì‚­ì œë©ë‹ˆë‹¤)')) return;
      if (!confirm('ì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ê³„ì†í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;

      try {
        await deleteAllVotes();
        await deleteAllParticipants();
        await deleteAllPresenters();
        alert('ëª¨ë“  ë°ì´í„°ê°€ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤.');
        await loadAllData();
      } catch (error) {
        alert('ì´ˆê¸°í™” ì‹¤íŒ¨: ' + error.message);
      }
    }
  </script>
</body>
</html>
