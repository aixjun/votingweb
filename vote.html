<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ì „ëµê¸°íšë¶€ë¬¸ íˆ¬í‘œ ì‹œìŠ¤í…œ - íˆ¬í‘œí•˜ê¸°</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="css/style.css">
</head>
<body>
  <!-- Kiwoom Logo -->
  <img src="assets/kiwoom_ci.png" class="kiwoom-logo" alt="í‚¤ì›€ì¦ê¶Œ">

  <!-- Floating Background Person -->
  <div class="floating-container">
    <img src="assets/jisan.jpg" class="floating-person" alt="Floating Person">
  </div>

  <div class="container">
    <header class="header">
      <h1>ğŸ—³ï¸ ì „ëµê¸°íšë¶€ë¬¸ íˆ¬í‘œí•˜ê¸°</h1>
      <p id="welcomeMsg">í™˜ì˜í•©ë‹ˆë‹¤!</p>
    </header>

    <main>
      <!-- ì„ íƒ ì¹´ìš´í„° -->
      <div class="selection-counter">
        <p>ì„ íƒëœ íŒ€: <span class="count" id="selectedCount">0</span> / <span id="maxVotes">5</span></p>
      </div>

      <!-- íˆ¬í‘œ ì™„ë£Œ ë©”ì‹œì§€ -->
      <div id="votedMessage" class="alert alert-success" style="display: none;">
        ì´ë¯¸ íˆ¬í‘œë¥¼ ì™„ë£Œí•˜ì…¨ìŠµë‹ˆë‹¤. ë‹¤ì‹œ íˆ¬í‘œí•˜ì‹œë©´ ê¸°ì¡´ íˆ¬í‘œê°€ ë³€ê²½ë©ë‹ˆë‹¤.
      </div>

      <!-- ë°œí‘œì ëª©ë¡ -->
      <div class="card">
        <h2 style="margin-bottom: 20px;">ë°œí‘œì ì„ íƒ</h2>
        <div class="vote-grid" id="presenterGrid">
          <div class="loading show">
            <div class="spinner"></div>
            <p>ë°œí‘œì ëª©ë¡ ë¡œë”© ì¤‘...</p>
          </div>
        </div>
      </div>

      <!-- ë²„íŠ¼ -->
      <div class="btn-group">
        <button class="btn btn-secondary" onclick="logout()">ë¡œê·¸ì•„ì›ƒ</button>
        <button class="btn btn-primary" id="submitBtn" disabled>íˆ¬í‘œí•˜ê¸°</button>
      </div>
    </main>

    <footer class="footer">
      <p>v1.0 | ì „ëµê¸°íšë¶€ë¬¸ íˆ¬í‘œ ì‹œìŠ¤í…œ</p>
    </footer>
  </div>

  <!-- Supabase -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="js/supabase-config.js"></script>
  <script src="js/api.js"></script>
  <script>
    let selectedPresenters = [];
    let maxVotes = 5;
    let presenters = [];
    let currentUser = null;

    document.addEventListener('DOMContentLoaded', async () => {
      // ë¡œê·¸ì¸ ì²´í¬
      currentUser = getCurrentUser();
      if (!currentUser || currentUser.isAdmin) {
        window.location.href = 'index.html';
        return;
      }

      document.getElementById('welcomeMsg').textContent =
        `${currentUser.name}ë‹˜ í™˜ì˜í•©ë‹ˆë‹¤!`;

      await loadSettings();
      await loadPresenters();
      await checkPreviousVotes();
    });

    async function loadSettings() {
      try {
        const settings = await getSettings();
        maxVotes = settings.max_votes || 5;
        document.getElementById('maxVotes').textContent = maxVotes;

        if (!settings.voting_open) {
          document.getElementById('submitBtn').disabled = true;
          document.getElementById('submitBtn').textContent = 'íˆ¬í‘œê°€ ì¢…ë£Œë˜ì—ˆìŠµë‹ˆë‹¤';
        }
      } catch (error) {
        console.error('ì„¤ì • ë¡œë“œ ì‹¤íŒ¨:', error);
      }
    }

    async function loadPresenters() {
      const grid = document.getElementById('presenterGrid');

      try {
        presenters = await getPresenters();

        if (presenters.length === 0) {
          grid.innerHTML = '<p style="text-align: center; color: #aaa;">ë“±ë¡ëœ ë°œí‘œìê°€ ì—†ìŠµë‹ˆë‹¤.</p>';
          return;
        }

        grid.innerHTML = presenters.map(p => `
          <div class="vote-card" data-id="${p.id}" onclick="toggleSelection(${p.id})">
            <h3>${p.team_name}</h3>
            <p>${p.presenter_name}</p>
            <p style="margin-top: 8px; font-size: 0.8rem;">${p.topic || ''}</p>
          </div>
        `).join('');

      } catch (error) {
        grid.innerHTML = '<p style="color: #ff4757;">ë°œí‘œì ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</p>';
        console.error('ë°œí‘œì ë¡œë“œ ì‹¤íŒ¨:', error);
      }
    }

    async function checkPreviousVotes() {
      try {
        const myVotes = await getMyVotes(currentUser.id);
        if (myVotes.length > 0) {
          document.getElementById('votedMessage').style.display = 'block';
          selectedPresenters = myVotes;
          updateSelectionUI();
        }
      } catch (error) {
        console.error('ì´ì „ íˆ¬í‘œ í™•ì¸ ì‹¤íŒ¨:', error);
      }
    }

    function toggleSelection(presenterId) {
      const index = selectedPresenters.indexOf(presenterId);

      if (index > -1) {
        // ì´ë¯¸ ì„ íƒë¨ -> í•´ì œ
        selectedPresenters.splice(index, 1);
      } else {
        // ìƒˆë¡œ ì„ íƒ
        if (selectedPresenters.length >= maxVotes) {
          alert(`ìµœëŒ€ ${maxVotes}ê°œ íŒ€ë§Œ ì„ íƒí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.`);
          return;
        }
        selectedPresenters.push(presenterId);
      }

      updateSelectionUI();
    }

    function updateSelectionUI() {
      // ì¹´ìš´í„° ì—…ë°ì´íŠ¸
      document.getElementById('selectedCount').textContent = selectedPresenters.length;

      // ì¹´ë“œ ì„ íƒ ìƒíƒœ ì—…ë°ì´íŠ¸
      document.querySelectorAll('.vote-card').forEach(card => {
        const id = parseInt(card.dataset.id);
        card.classList.toggle('selected', selectedPresenters.includes(id));
      });

      // ë²„íŠ¼ ìƒíƒœ ì—…ë°ì´íŠ¸
      const submitBtn = document.getElementById('submitBtn');
      submitBtn.disabled = selectedPresenters.length !== maxVotes;
    }

    document.getElementById('submitBtn').addEventListener('click', async () => {
      if (selectedPresenters.length !== maxVotes) {
        alert(`${maxVotes}ê°œ íŒ€ì„ ì„ íƒí•´ì£¼ì„¸ìš”.`);
        return;
      }

      if (!confirm('íˆ¬í‘œë¥¼ ì œì¶œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
        return;
      }

      const submitBtn = document.getElementById('submitBtn');
      submitBtn.disabled = true;
      submitBtn.textContent = 'ì œì¶œ ì¤‘...';

      try {
        await submitVotes(currentUser.id, selectedPresenters);
        alert('íˆ¬í‘œê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!');
        document.getElementById('votedMessage').style.display = 'block';
      } catch (error) {
        alert('íˆ¬í‘œ ì œì¶œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ' + error.message);
      } finally {
        submitBtn.disabled = false;
        submitBtn.textContent = 'íˆ¬í‘œí•˜ê¸°';
      }
    });
  </script>
</body>
</html>
